<!-- Use the array of pages passed as a param -->
{{ range .Pages -}}
<!-- Don't process empty content files -->
  {{- if ne (len .Content) 0 -}}
    <!-- Remove the <hr /> tag generated by blackfriday for footnotes -->
    {{- $content := replace .Content "<div class=\"footnotes\">\n\n<hr />" "<div class=\"footnotes\">" -}}
    <!-- Split the processed content by <hr /> tag -->
    {{- range $elem_index, $elem_val := split $content "<hr />" -}}
      {{- $.Scratch.Delete "class" -}}
      {{- $.Scratch.Delete "id" -}}
      {{- $.Scratch.Delete "bgi" -}}
      
      <!-- Get slide properties from first line with HTML comment -->
      {{- $first := index (findRE "<!--(.+)-->" $elem_val 1) 0 -}}
      {{- with $first -}}
        {{- $.Scratch.Set "class" (replace (delimit (findRE " [/.][^ ]+" $first) " ") " ." "") -}}
        {{- $.Scratch.Set "id" (replace (delimit (findRE " #[^ ]+" $first) "-") " #" "") -}}
        {{- $.Scratch.Set "bgi" (replace (delimit (findRE " bgimage=[^ ]+" $first) "-") " bgimage=" "") -}}
      {{- end -}}
      {{- $elem_val := replace $elem_val $first "" -}}

      <!-- Get block class from ::: -->
      {{- $elem_val := replaceRE "<([^ ]+)([^>]+)?>([^<]+) ::: ([^<]+)</[^>]+>" "<$1$2 class=\"$4\">$3</$1>" $elem_val -}}
      <section id="slide{{ add 1 $elem_index }}"{{ with $.Params.bg }} class="{{ . }}"{{ end }}>
        {{- with $.Scratch.Get "bgi" -}}
        <span class="background" style="background-image:url('{{ . }}')"></span>
        {{- end }}
        <div{{ with $.Scratch.Get "class" }} class="{{ . }}"{{ end }}>
        {{- $grid := split $elem_val "<p>|||</p>" -}}
        {{- $.Scratch.Set "grid" 0 -}}
        {{- range $grid_index, $grid_val := $grid -}}
          {{- if eq $grid_index 0 -}}
            {{ . | safeHTML }}
          {{- else -}}
            {{- if eq ($.Scratch.Get "grid") 0 }}
          <div class="grid">
              {{- $.Scratch.Set "grid" 1 -}}
            {{- end }}
            <div class="column">{{ . | safeHTML}}</div>
            {{- if eq (add $grid_index 1) (len $grid) }}
          </div>
            {{- end -}}
          {{- end -}} <!-- grid_index -->
        {{- end -}} <!-- range grid -->
        </div>
      </section>
    {{- end -}} <!-- range content -->
  {{- end -}} <!-- if content -->
{{- end }} <!-- range .Pages -->
